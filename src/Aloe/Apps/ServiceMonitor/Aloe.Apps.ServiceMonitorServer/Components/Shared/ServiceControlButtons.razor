@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@inject IServiceManager ServiceManager

@if (Service != null)
{
    @if (pendingConfirmAction != null)
    {
        <aside class="alert alert-warning" role="alert" style="margin-bottom: 0">
            <div class="mb-2">
                @GetConfirmMessage()
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
                @if (pendingConfirmAction == "stop")
                {
                    <button type="button" class="danger btn-sm" @onclick="ConfirmStopService">はい、停止する</button>
                }
                @if (pendingConfirmAction == "restart")
                {
                    <button type="button" class="warning btn-sm" @onclick="ConfirmRestartService">はい、再起動する</button>
                }
                <button type="button" class="secondary btn-sm" @onclick="CancelConfirmation">キャンセル</button>
            </div>
        </aside>
    }
    else
    {
        @if (Service.Status != ServiceStatus.Running)
        {
            <div style="display: flex; gap: 0.5rem; width: 100%">
                <button type="button" class="success btn-sm" @onclick="() => StartService()" disabled="@isProcessing" style="flex: 1">
                    @if (isProcessing && currentAction == "start")
                    {
                        <span class="spinner" role="status" aria-hidden="true"></span>
                    }
                    起動
                </button>
            </div>
        }

        @if (Service.Status == ServiceStatus.Running)
        {
            <div style="display: flex; gap: 0.5rem; width: 100%; align-items: center">
                <button type="button" class="success btn-sm" disabled="@isProcessing" style="flex: 1">
                    実行中
                </button>
                <div style="display: flex; gap: 0.25rem">
                    <button type="button" class="danger btn-xs" @onclick="InitiateStopService" disabled="@isProcessing" title="停止">
                        @if (isProcessing && currentAction == "stop")
                        {
                            <span class="spinner" role="status" aria-hidden="true"></span>
                        }
                        else
                        {
                            <span>停止</span>
                        }
                    </button>
                    <button type="button" class="warning btn-xs" @onclick="InitiateRestartService" disabled="@isProcessing" title="再起動">
                        @if (isProcessing && currentAction == "restart")
                        {
                            <span class="spinner" role="status" aria-hidden="true"></span>
                        }
                        else
                        {
                            <span>再起動</span>
                        }
                    </button>
                </div>
            </div>
        }
    }
}

@{
    string GetConfirmMessage()
    {
        return pendingConfirmAction switch
        {
            "stop" => $"'{Service?.DisplayName}' を停止します。よろしいですか？",
            "restart" => $"'{Service?.DisplayName}' を再起動します。よろしいですか？",
            _ => string.Empty
        };
    }
}

@code {
    [Parameter]
    public ServiceInfo? Service { get; set; }

    [Parameter]
    public EventCallback<(string, bool)> OnOperationComplete { get; set; }

    private bool isProcessing = false;
    private string currentAction = string.Empty;
    private string? pendingConfirmAction = null;

    private async Task StartService()
    {
        if (Service == null) return;
        isProcessing = true;
        currentAction = "start";

        var result = await ServiceManager.StartServiceAsync(Service.ServiceName);
        await OnOperationComplete.InvokeAsync((result.Message, result.Success));

        isProcessing = false;
        currentAction = string.Empty;
    }

    private void InitiateStopService()
    {
        if (Service == null) return;
        pendingConfirmAction = "stop";
    }

    private async Task ConfirmStopService()
    {
        if (Service == null) return;
        pendingConfirmAction = null;

        isProcessing = true;
        currentAction = "stop";

        var result = await ServiceManager.StopServiceAsync(Service.ServiceName);
        await OnOperationComplete.InvokeAsync((result.Message, result.Success));

        isProcessing = false;
        currentAction = string.Empty;
    }

    private void InitiateRestartService()
    {
        if (Service == null) return;
        pendingConfirmAction = "restart";
    }

    private async Task ConfirmRestartService()
    {
        if (Service == null) return;
        pendingConfirmAction = null;

        isProcessing = true;
        currentAction = "restart";

        var result = await ServiceManager.RestartServiceAsync(Service.ServiceName);
        await OnOperationComplete.InvokeAsync((result.Message, result.Success));

        isProcessing = false;
        currentAction = string.Empty;
    }

    private void CancelConfirmation()
    {
        pendingConfirmAction = null;
    }
}
