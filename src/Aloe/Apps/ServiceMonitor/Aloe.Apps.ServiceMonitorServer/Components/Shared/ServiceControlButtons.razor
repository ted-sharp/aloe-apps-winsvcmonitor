@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@inject IServiceManager ServiceManager

<ConfirmationModal
    Title="@GetConfirmTitle()"
    Message="@GetConfirmMessage()"
    ConfirmButtonText="@GetConfirmButtonText()"
    ConfirmButtonClass="@GetConfirmButtonClass()"
    OnConfirm="@ConfirmAction" />

@if (Service != null)
{
    <div class="button-group compact">
        <button type="button" class="success btn-xs" @onclick="() => StartService()" disabled="@(isProcessing || Service.Status != ServiceStatus.Stopped)" title="起動">
            @if (isProcessing && currentAction == "start")
            {
                <span class="spinner" role="status" aria-hidden="true"></span>
            }
            else
            {
                <span>起動</span>
            }
        </button>
        <button type="button" class="danger btn-xs" @onclick="InitiateStopService" popovertarget="service-confirm-modal" disabled="@(isProcessing || Service.Status != ServiceStatus.Running)" title="停止">
            @if (isProcessing && currentAction == "stop")
            {
                <span class="spinner" role="status" aria-hidden="true"></span>
            }
            else
            {
                <span>停止</span>
            }
        </button>
        <button type="button" class="warning btn-xs" @onclick="InitiateRestartService" popovertarget="service-confirm-modal" disabled="@(isProcessing || Service.Status != ServiceStatus.Running)" title="再起動">
            @if (isProcessing && currentAction == "restart")
            {
                <span class="spinner" role="status" aria-hidden="true"></span>
            }
            else
            {
                <span>再起動</span>
            }
        </button>
    </div>
}

@{
    string GetConfirmTitle()
    {
        return pendingConfirmAction switch
        {
            "stop" => "サービスを停止",
            "restart" => "サービスを再起動",
            _ => string.Empty
        };
    }

    string GetConfirmMessage()
    {
        return pendingConfirmAction switch
        {
            "stop" => $"'{Service?.DisplayName}' を停止します。よろしいですか？",
            "restart" => $"'{Service?.DisplayName}' を再起動します。よろしいですか？",
            _ => string.Empty
        };
    }

    string GetConfirmButtonText()
    {
        return pendingConfirmAction switch
        {
            "stop" => "停止する",
            "restart" => "再起動する",
            _ => "確認"
        };
    }

    string GetConfirmButtonClass()
    {
        return pendingConfirmAction switch
        {
            "stop" => "danger",
            "restart" => "warning",
            _ => "primary"
        };
    }
}

@code {
    [Parameter]
    public ServiceInfo? Service { get; set; }

    [Parameter]
    public EventCallback<(string, bool)> OnOperationComplete { get; set; }

    private bool isProcessing = false;
    private string currentAction = string.Empty;
    private string? pendingConfirmAction = null;

    private async Task StartService()
    {
        if (Service == null) return;
        isProcessing = true;
        currentAction = "start";

        var result = await ServiceManager.StartServiceAsync(Service.ServiceName);
        await OnOperationComplete.InvokeAsync((result.Message, result.Success));

        isProcessing = false;
        currentAction = string.Empty;
    }

    private void InitiateStopService()
    {
        if (Service == null) return;
        pendingConfirmAction = "stop";
    }

    private void InitiateRestartService()
    {
        if (Service == null) return;
        pendingConfirmAction = "restart";
    }

    private async Task ConfirmAction()
    {
        if (Service == null || pendingConfirmAction == null) return;

        var action = pendingConfirmAction;
        pendingConfirmAction = null;
        isProcessing = true;
        currentAction = action;

        ServiceOperationResult result = action switch
        {
            "stop" => await ServiceManager.StopServiceAsync(Service.ServiceName),
            "restart" => await ServiceManager.RestartServiceAsync(Service.ServiceName),
            _ => new ServiceOperationResult { Success = false, Message = "不正なアクション" }
        };

        await OnOperationComplete.InvokeAsync((result.Message, result.Success));

        isProcessing = false;
        currentAction = string.Empty;
    }

}
