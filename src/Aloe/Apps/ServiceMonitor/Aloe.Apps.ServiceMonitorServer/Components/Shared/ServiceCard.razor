@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@inject IServiceManager ServiceManager

@if (Service != null)
{
    <article class="service-card">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center">
                <div>
                    <h5 class="mb-1">@Service.DisplayName</h5>
                    <small>@Service.ServiceName</small>
                </div>
                <mark class="badge @GetStatusBadgeClass()">
                    @GetStatusText()
                </mark>
            </div>
        </header>

        @if (!string.IsNullOrEmpty(Service.Description))
        {
            <p style="margin: 0.5rem 0; color: var(--muted-color); font-size: 0.9rem">@Service.Description</p>
        }

        <div class="service-details">
            <div class="service-detail-item">
                <span class="service-detail-label">ステータス</span>
                <span class="service-detail-value">@GetStatusText()</span>
            </div>
            <div class="service-detail-item">
                <span class="service-detail-label">起動タイプ</span>
                <span class="service-detail-value">@Service.StartupType</span>
            </div>

            @if (Service.Status == ServiceStatus.Running && Service.Uptime != TimeSpan.Zero)
            {
                <div class="service-detail-item">
                    <span class="service-detail-label">稼働時間</span>
                    <span class="service-detail-value">@FormatUptime(Service.Uptime)</span>
                </div>
            }

            @if (Service.MemoryUsageMB > 0)
            {
                <div class="service-detail-item">
                    <span class="service-detail-label">メモリ使用量</span>
                    <span class="service-detail-value">@Service.MemoryUsageMB.ToString("F1") MB</span>
                </div>
            }

            @if (Service.ProcessId > 0)
            {
                <div class="service-detail-item">
                    <span class="service-detail-label">プロセスID</span>
                    <span class="service-detail-value">@Service.ProcessId</span>
                </div>
            }

            @if (Service.DependentServicesCount > 0)
            {
                <div class="service-detail-item">
                    <span class="service-detail-label">依存サービス</span>
                    <span class="service-detail-value">@Service.DependentServicesCount 個</span>
                </div>
            }

            @if (Service.LastStatusChange.HasValue)
            {
                <div class="service-detail-item">
                    <span class="service-detail-label">最終変更</span>
                    <span class="service-detail-value">@FormatRelativeTime(Service.LastStatusChange.Value)</span>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(operationMessage))
        {
            <aside class="alert @(operationSuccess ? "alert-success" : "alert-danger") alert-sm" role="alert">
                @operationMessage
            </aside>
        }

        @if (showRemoveConfirm)
        {
            <aside class="alert alert-warning" role="alert" style="margin-bottom: 1rem">
                <div style="margin-bottom: 0.5rem">このサービスの監視を削除しますか？</div>
                <div style="display: flex; gap: 0.5rem">
                    <button type="button" class="danger btn-xs" @onclick="ConfirmRemove">削除</button>
                    <button type="button" class="secondary btn-xs" @onclick="CancelRemove">キャンセル</button>
                </div>
            </aside>
        }

        <footer style="margin-top: auto; padding-top: 1rem">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem">
                <div style="flex: 1">
                    <ServiceControlButtons Service="Service" OnOperationComplete="OnOperationComplete" />
                </div>
            </div>
            <button type="button" class="secondary btn-xs" @onclick="InitiateRemove" disabled="@isRemoving" style="width: 100%">
                @if (isRemoving)
                {
                    <span class="spinner" role="status" aria-hidden="true"></span>
                }
                監視から削除
            </button>
        </footer>
    </article>
}

@code {
    [Parameter]
    public ServiceInfo? Service { get; set; }

    [Parameter]
    public EventCallback OnServiceChanged { get; set; }

    [Parameter]
    public EventCallback<string> OnRemoveService { get; set; }

    private string operationMessage = string.Empty;
    private bool operationSuccess = false;
    private bool showRemoveConfirm = false;
    private bool isRemoving = false;

    private string GetStatusText()
    {
        return Service?.Status switch
        {
            ServiceStatus.Running => "実行中",
            ServiceStatus.Stopped => "停止中",
            ServiceStatus.Paused => "一時停止中",
            ServiceStatus.Starting => "起動中",
            ServiceStatus.Stopping => "停止中",
            ServiceStatus.Continuing => "再開中",
            ServiceStatus.Pausing => "一時停止中",
            _ => "不明"
        };
    }

    private string GetStatusBadgeClass()
    {
        return Service?.Status switch
        {
            ServiceStatus.Running => "success",
            ServiceStatus.Stopped => "danger",
            ServiceStatus.Paused => "warning",
            ServiceStatus.Starting => "info",
            ServiceStatus.Stopping => "secondary",
            _ => "secondary"
        };
    }

    private string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}日 {uptime.Hours}時間 {uptime.Minutes}分";
        else if (uptime.TotalHours >= 1)
            return $"{uptime.Hours}時間 {uptime.Minutes}分";
        else
            return $"{uptime.Minutes}分";
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.Now - dateTime;
        if (diff.TotalSeconds < 60)
            return "数秒前";
        else if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}分前";
        else if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}時間前";
        else
            return $"{(int)diff.TotalDays}日前";
    }

    private async Task OnOperationComplete((string, bool) result)
    {
        operationMessage = result.Item1;
        operationSuccess = result.Item2;
        await OnServiceChanged.InvokeAsync();
        await Task.Delay(3000);
        operationMessage = string.Empty;
    }

    private void InitiateRemove()
    {
        showRemoveConfirm = true;
    }

    private async Task ConfirmRemove()
    {
        if (Service == null) return;
        isRemoving = true;
        showRemoveConfirm = false;

        await OnRemoveService.InvokeAsync(Service.ServiceName);
        isRemoving = false;
    }

    private void CancelRemove()
    {
        showRemoveConfirm = false;
    }
}
