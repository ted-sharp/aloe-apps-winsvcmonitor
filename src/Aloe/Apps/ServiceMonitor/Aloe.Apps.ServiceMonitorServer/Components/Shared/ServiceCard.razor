@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@inject IServiceManager ServiceManager

@if (Service != null)
{
    <div class="card h-100">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">@Service.DisplayName</h5>
                    <small class="text-muted">@Service.ServiceName</small>
                </div>
                <span class="badge @GetStatusBadgeClass()">
                    @GetStatusText()
                </span>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <strong>ステータス:</strong> @GetStatusText()
            </div>

            @if (!string.IsNullOrEmpty(Service.Description))
            {
                <div class="mb-3">
                    <strong>説明:</strong>
                    <p class="text-muted mb-0">@Service.Description</p>
                </div>
            }

            <div class="mb-3">
                <strong>起動タイプ:</strong> @Service.StartupType
            </div>

            @if (Service.ProcessId > 0)
            {
                <div class="mb-3">
                    <strong>プロセスID:</strong> @Service.ProcessId
                </div>
            }

            @if (!string.IsNullOrEmpty(operationMessage))
            {
                <div class="alert @(operationSuccess ? "alert-success" : "alert-danger") alert-sm" role="alert">
                    @operationMessage
                </div>
            }
        </div>
        <div class="card-footer bg-light">
            <ServiceControlButtons Service="Service" OnOperationComplete="OnOperationComplete" />
        </div>
    </div>
}

@code {
    [Parameter]
    public ServiceInfo? Service { get; set; }

    [Parameter]
    public EventCallback OnServiceChanged { get; set; }

    private string operationMessage = string.Empty;
    private bool operationSuccess = false;

    private string GetStatusText()
    {
        return Service?.Status switch
        {
            ServiceStatus.Running => "実行中",
            ServiceStatus.Stopped => "停止中",
            ServiceStatus.Paused => "一時停止中",
            ServiceStatus.Starting => "起動中",
            ServiceStatus.Stopping => "停止中",
            ServiceStatus.Continuing => "再開中",
            ServiceStatus.Pausing => "一時停止中",
            _ => "不明"
        };
    }

    private string GetStatusBadgeClass()
    {
        return Service?.Status switch
        {
            ServiceStatus.Running => "bg-success",
            ServiceStatus.Stopped => "bg-danger",
            ServiceStatus.Paused => "bg-warning text-dark",
            ServiceStatus.Starting => "bg-info",
            ServiceStatus.Stopping => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private async Task OnOperationComplete((string, bool) result)
    {
        operationMessage = result.Item1;
        operationSuccess = result.Item2;
        await OnServiceChanged.InvokeAsync();
        await Task.Delay(3000);
        operationMessage = string.Empty;
    }
}
