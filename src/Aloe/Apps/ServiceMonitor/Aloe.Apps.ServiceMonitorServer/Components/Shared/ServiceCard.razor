@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@inject IServiceManager ServiceManager

@if (Service != null)
{
    <article style="height: 100%">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center">
                <div>
                    <h5 class="mb-1">@Service.DisplayName</h5>
                    <small>@Service.ServiceName</small>
                </div>
                <mark class="badge @GetStatusBadgeClass()">
                    @GetStatusText()
                </mark>
            </div>
        </header>
        <div class="mb-3">
            <strong>ステータス:</strong> @GetStatusText()
        </div>

        @if (!string.IsNullOrEmpty(Service.Description))
        {
            <div class="mb-3">
                <strong>説明:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--muted-color)">@Service.Description</p>
            </div>
        }

        <div class="mb-3">
            <strong>起動タイプ:</strong> @Service.StartupType
        </div>

        @if (Service.ProcessId > 0)
        {
            <div class="mb-3">
                <strong>プロセスID:</strong> @Service.ProcessId
            </div>
        }

        @if (!string.IsNullOrEmpty(operationMessage))
        {
            <aside class="alert @(operationSuccess ? "alert-success" : "alert-danger") alert-sm" role="alert">
                @operationMessage
            </aside>
        }
        <footer>
            <ServiceControlButtons Service="Service" OnOperationComplete="OnOperationComplete" />
        </footer>
    </article>
}

@code {
    [Parameter]
    public ServiceInfo? Service { get; set; }

    [Parameter]
    public EventCallback OnServiceChanged { get; set; }

    private string operationMessage = string.Empty;
    private bool operationSuccess = false;

    private string GetStatusText()
    {
        return Service?.Status switch
        {
            ServiceStatus.Running => "実行中",
            ServiceStatus.Stopped => "停止中",
            ServiceStatus.Paused => "一時停止中",
            ServiceStatus.Starting => "起動中",
            ServiceStatus.Stopping => "停止中",
            ServiceStatus.Continuing => "再開中",
            ServiceStatus.Pausing => "一時停止中",
            _ => "不明"
        };
    }

    private string GetStatusBadgeClass()
    {
        return Service?.Status switch
        {
            ServiceStatus.Running => "bg-success",
            ServiceStatus.Stopped => "bg-danger",
            ServiceStatus.Paused => "bg-warning text-dark",
            ServiceStatus.Starting => "bg-info",
            ServiceStatus.Stopping => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private async Task OnOperationComplete((string, bool) result)
    {
        operationMessage = result.Item1;
        operationSuccess = result.Item2;
        await OnServiceChanged.InvokeAsync();
        await Task.Delay(3000);
        operationMessage = string.Empty;
    }
}
