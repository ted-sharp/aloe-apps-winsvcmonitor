@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@inject IServiceManager ServiceManager

@if (Service != null)
{
    <article class="service-card" style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start">
        <div>
            <header style="margin-bottom: 1rem">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem">
                    <div>
                        <h5 class="mb-1">@Service.DisplayName</h5>
                        <small>@Service.ServiceName</small>
                    </div>
                    <mark class="badge @GetStatusBadgeClass()" style="white-space: nowrap">
                        @GetStatusText()
                    </mark>
                </div>
            </header>

            @if (!string.IsNullOrEmpty(Service.Description))
            {
                <p style="margin: 0 0 1rem 0; color: var(--muted-color); font-size: 0.9rem">@Service.Description</p>
            }

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem">
                <div class="service-detail-item">
                    <span class="service-detail-label">ステータス</span>
                    <span class="service-detail-value">@GetStatusText()</span>
                </div>
                <div class="service-detail-item">
                    <span class="service-detail-label">起動タイプ</span>
                    <span class="service-detail-value">@Service.StartupType</span>
                </div>

                @if (Service.Status == ServiceStatus.Running && Service.Uptime != TimeSpan.Zero)
                {
                    <div class="service-detail-item">
                        <span class="service-detail-label">稼働時間</span>
                        <span class="service-detail-value">@FormatUptime(Service.Uptime)</span>
                    </div>
                }

                @if (Service.MemoryUsageMB > 0)
                {
                    <div class="service-detail-item">
                        <span class="service-detail-label">メモリ使用量</span>
                        <span class="service-detail-value">@Service.MemoryUsageMB.ToString("F1") MB</span>
                    </div>
                }

                @if (Service.ProcessId > 0)
                {
                    <div class="service-detail-item">
                        <span class="service-detail-label">プロセスID</span>
                        <span class="service-detail-value">@Service.ProcessId</span>
                    </div>
                }

                @if (Service.DependentServicesCount > 0)
                {
                    <div class="service-detail-item">
                        <span class="service-detail-label">依存サービス</span>
                        <span class="service-detail-value">@Service.DependentServicesCount 個</span>
                    </div>
                }

                @if (Service.LastStatusChange.HasValue)
                {
                    <div class="service-detail-item">
                        <span class="service-detail-label">最終変更</span>
                        <span class="service-detail-value">@FormatRelativeTime(Service.LastStatusChange.Value)</span>
                    </div>
                }
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 0.5rem; min-width: 200px">
            <ServiceControlButtons Service="Service" OnOperationComplete="OnOperationComplete" />
            <button type="button" class="secondary btn-xs" @onclick="InitiateUnregister" disabled="@(Service?.Status != ServiceStatus.Stopped || isUnregistering)" title="停止状態のときのみ解除できます">
                @if (isUnregistering)
                {
                    <span class="spinner" role="status" aria-hidden="true"></span>
                }
                サービスを解除
            </button>
        </div>

        @if (showUnregisterConfirm)
        {
            <aside class="alert alert-warning" role="alert" style="margin-top: 1rem; grid-column: 1 / -1">
                <div style="margin-bottom: 0.5rem">サービスを監視対象から解除します。</div>
                <div style="display: flex; gap: 0.5rem">
                    <button type="button" class="danger btn-xs" @onclick="ConfirmUnregister">解除</button>
                    <button type="button" class="secondary btn-xs" @onclick="CancelUnregister">キャンセル</button>
                </div>
            </aside>
        }
    </article>
}

@code {
    [Parameter]
    public ServiceInfo? Service { get; set; }

    [Parameter]
    public EventCallback OnServiceChanged { get; set; }

    [Parameter]
    public EventCallback<string> OnDeleteService { get; set; }

    private string operationMessage = string.Empty;
    private bool operationSuccess = false;
    private bool showUnregisterConfirm = false;
    private bool isUnregistering = false;

    private string GetStatusText()
    {
        return Service?.Status switch
        {
            ServiceStatus.Running => "実行中",
            ServiceStatus.Stopped => "停止中",
            ServiceStatus.Paused => "一時停止中",
            ServiceStatus.Starting => "起動中",
            ServiceStatus.Stopping => "停止中",
            ServiceStatus.Continuing => "再開中",
            ServiceStatus.Pausing => "一時停止中",
            _ => "不明"
        };
    }

    private string GetStatusBadgeClass()
    {
        return Service?.Status switch
        {
            ServiceStatus.Running => "success",
            ServiceStatus.Stopped => "danger",
            ServiceStatus.Paused => "warning",
            ServiceStatus.Starting => "info",
            ServiceStatus.Stopping => "secondary",
            _ => "secondary"
        };
    }

    private string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}日 {uptime.Hours}時間 {uptime.Minutes}分";
        else if (uptime.TotalHours >= 1)
            return $"{uptime.Hours}時間 {uptime.Minutes}分";
        else
            return $"{uptime.Minutes}分";
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.Now - dateTime;
        if (diff.TotalSeconds < 60)
            return "数秒前";
        else if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}分前";
        else if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}時間前";
        else
            return $"{(int)diff.TotalDays}日前";
    }

    private async Task OnOperationComplete((string, bool) result)
    {
        operationMessage = result.Item1;
        operationSuccess = result.Item2;
        await OnServiceChanged.InvokeAsync();
        await Task.Delay(3000);
        operationMessage = string.Empty;
    }

    private void InitiateUnregister()
    {
        showUnregisterConfirm = true;
    }

    private async Task ConfirmUnregister()
    {
        if (Service == null) return;
        isUnregistering = true;
        showUnregisterConfirm = false;

        await OnDeleteService.InvokeAsync(Service.ServiceName);
        isUnregistering = false;
    }

    private void CancelUnregister()
    {
        showUnregisterConfirm = false;
    }
}
