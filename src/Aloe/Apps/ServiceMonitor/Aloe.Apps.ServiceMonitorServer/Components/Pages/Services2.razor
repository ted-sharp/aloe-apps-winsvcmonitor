@page "/services2"
@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@using Aloe.Apps.ServiceMonitorServer.Components.Shared
@attribute [Authorize]
@inject IServiceManager ServiceManager
@inject IServiceRegistrar ServiceRegistrar
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>サービス監視 v2</PageTitle>

<main class="container">
    <hgroup>
        <h1>Windows サービス監視</h1>
        <p>Pico.css クラスレス版</p>
    </hgroup>

    <div role="group">
        <button @onclick="RefreshServices" disabled="@isLoadingServices">リフレッシュ</button>
        <button class="success" @onclick="StartAllServices" disabled="@isLoadingServices">すべて起動</button>
        <button class="danger" @onclick="StopAllServices" disabled="@isLoadingServices">すべて停止</button>
        <button class="warning" @onclick="RestartAllServices" disabled="@isLoadingServices">すべて再起動</button>
    </div>

    @if (services == null)
    {
        <article aria-busy="true">ロード中...</article>
    }
    else if (services.Count == 0)
    {
        <article>
            <p>監視対象のサービスが設定されていません。appsettings.services.json を設定してください。</p>
        </article>
    }
    else
    {
        @foreach (var service in services)
        {
            <article>
                <header>
                    <hgroup>
                        <h3>@service.DisplayName <small>(@service.ServiceName)</small></h3>
                    </hgroup>
                    <mark>@GetStatusText(service)</mark>
                </header>

                @if (!string.IsNullOrEmpty(service.Description))
                {
                    <p><small>@service.Description</small></p>
                }
                @if (!string.IsNullOrEmpty(service.BinaryPath))
                {
                    <p><small>@service.BinaryPath</small></p>
                }

                <div class="grid">
                    <div>
                        <small>起動タイプ</small><br/>
                        <strong>@service.StartupType</strong>
                    </div>

                    @if (service.Status == ServiceStatus.Running && service.Uptime != TimeSpan.Zero)
                    {
                        <div>
                            <small>稼働時間</small><br/>
                            <strong>@FormatUptime(service.Uptime)</strong>
                        </div>
                    }

                    @if (service.MemoryUsageMB > 0)
                    {
                        <div>
                            <small>メモリ使用量</small><br/>
                            <strong>@service.MemoryUsageMB.ToString("F1") MB</strong>
                        </div>
                    }

                    @if (service.ProcessId > 0)
                    {
                        <div>
                            <small>プロセスID</small><br/>
                            <strong>@service.ProcessId</strong>
                        </div>
                    }

                    @if (service.DependentServicesCount > 0)
                    {
                        <div>
                            <small>依存サービス</small><br/>
                            <strong>@service.DependentServicesCount 個</strong>
                        </div>
                    }

                    @if (service.LastStatusChange.HasValue)
                    {
                        <div>
                            <small>最終変更</small><br/>
                            <strong>@FormatRelativeTime(service.LastStatusChange.Value)</strong>
                        </div>
                    }

                </div>

                <footer>
                    <div role="group">
                        <button class="success" @onclick="() => StartService(service.ServiceName)" disabled="@(service.Status != ServiceStatus.Stopped)">起動</button>
                        <button class="danger" @onclick="() => StopService(service.ServiceName)" disabled="@(service.Status != ServiceStatus.Running)">停止</button>
                        <button class="warning" @onclick="() => RestartService(service.ServiceName)" disabled="@(service.Status != ServiceStatus.Running)">再起動</button>
                    </div>
                    <div role="group">
                        <button class="contrast outline" @onclick="() => RegisterService(service)" disabled="@(service.Status != ServiceStatus.Unknown || string.IsNullOrEmpty(service.BinaryPath))">登録</button>
                        <button class="contrast outline" @onclick="() => DeleteService(service.ServiceName)" disabled="@(service.Status != ServiceStatus.Stopped)">解除</button>
                    </div>
                </footer>
            </article>
        }
    }
</main>

@code {
    private List<ServiceInfo>? services;
    private bool isLoadingServices = false;
    private PeriodicTimer? pollingTimer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshServices();
        pollingTimer = new PeriodicTimer(TimeSpan.FromSeconds(3));
        _ = PollAsync();
    }

    private async Task PollAsync()
    {
        while (await pollingTimer!.WaitForNextTickAsync())
        {
            await InvokeAsync(async () =>
            {
                if (!isLoadingServices)
                    await RefreshServices();
            });
        }
    }

    private async Task RefreshServices()
    {
        isLoadingServices = true;
        try { services = await ServiceManager.GetAllServicesAsync(); }
        catch { }
        finally { isLoadingServices = false; }
    }

    private async Task StartService(string name)
    {
        await ServiceManager.StartServiceAsync(name);
        await RefreshServices();
    }

    private async Task StopService(string name)
    {
        await ServiceManager.StopServiceAsync(name);
        await RefreshServices();
    }

    private async Task RestartService(string name)
    {
        await ServiceManager.RestartServiceAsync(name);
        await RefreshServices();
    }

    private async Task DeleteService(string name)
    {
        await ServiceManager.DeleteServiceAsync(name);
        await RefreshServices();
    }

    private async Task RegisterService(ServiceInfo service)
    {
        var request = new ServiceRegistrationRequest
        {
            ServiceName = service.ServiceName,
            DisplayName = service.DisplayName,
            BinaryPath = service.BinaryPath
        };
        await ServiceRegistrar.RegisterServiceAsync(request);
        await RefreshServices();
    }

    private async Task StartAllServices()
    {
        if (services == null) return;
        foreach (var s in services.Where(s => s.Status != ServiceStatus.Running))
            await ServiceManager.StartServiceAsync(s.ServiceName);
        await RefreshServices();
    }

    private async Task StopAllServices()
    {
        if (services == null) return;
        foreach (var s in services.Where(s => s.Status == ServiceStatus.Running))
            await ServiceManager.StopServiceAsync(s.ServiceName);
        await RefreshServices();
    }

    private async Task RestartAllServices()
    {
        if (services == null) return;
        foreach (var s in services.Where(s => s.Status == ServiceStatus.Running))
            await ServiceManager.RestartServiceAsync(s.ServiceName);
        await RefreshServices();
    }

    private string GetStatusText(ServiceInfo service)
    {
        return service.Status switch
        {
            ServiceStatus.Running => "実行中",
            ServiceStatus.Stopped => "停止",
            ServiceStatus.Paused => "一時停止",
            ServiceStatus.Starting => "起動中",
            ServiceStatus.Stopping => "停止中",
            ServiceStatus.Continuing => "再開中",
            ServiceStatus.Pausing => "一時停止中",
            _ => "不明"
        };
    }

    private string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}日 {uptime.Hours}時間 {uptime.Minutes}分";
        else if (uptime.TotalHours >= 1)
            return $"{uptime.Hours}時間 {uptime.Minutes}分";
        else
            return $"{uptime.Minutes}分";
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.Now - dateTime;
        if (diff.TotalSeconds < 60) return "数秒前";
        else if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}分前";
        else if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}時間前";
        else return $"{(int)diff.TotalDays}日前";
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        pollingTimer?.Dispose();
    }
}
