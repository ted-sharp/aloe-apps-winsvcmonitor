@page "/services"
@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@using Aloe.Apps.ServiceMonitorServer.Components.Shared
@attribute [Authorize]
@inject IServiceManager ServiceManager
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>サービス監視</PageTitle>

<main class="container">
    <div class="page-header">
        <h1>Windows サービス監視</h1>
        <div class="button-group">
            <button class="btn-sm" @onclick="RefreshServices" disabled="@isLoadingServices">
                リフレッシュ
            </button>
            <button class="success btn-sm" @onclick="StartAllServices" disabled="@isLoadingServices">
                すべて起動
            </button>
            <button class="danger btn-sm" @onclick="StopAllServices" disabled="@isLoadingServices">
                すべて停止
            </button>
            <button class="warning btn-sm" @onclick="RestartAllServices" disabled="@isLoadingServices">
                すべて再起動
            </button>
        </div>
    </div>

    @if (services == null)
    {
        <aside class="alert alert-info" role="alert">
            <span class="spinner" role="status" aria-hidden="true"></span>
            ロード中...
        </aside>
    }
    else if (services.Count == 0)
    {
        <aside class="alert alert-warning" role="alert">
            監視対象のサービスが設定されていません。appsettings.services.json を設定してください。
        </aside>
    }
    else
    {
        <div class="service-list">
            @foreach (var service in services)
            {
                <ServiceCard Service="service" OnServiceChanged="RefreshServices" OnDeleteService="HandleDeleteService" />
            }
        </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <aside class="alert @(statusMessageIsSuccess ? "alert-success" : "alert-danger") alert-sm status-toast" role="alert">
            @statusMessage
        </aside>
    }
</main>

@code {
    private List<ServiceInfo>? services;
    private bool isLoadingServices = false;
    private string statusMessage = string.Empty;
    private bool statusMessageIsSuccess = false;
    private PeriodicTimer? pollingTimer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshServices();
        StartPolling();
    }

    private void StartPolling()
    {
        pollingTimer = new PeriodicTimer(TimeSpan.FromSeconds(3));
        _ = PollServicesAsync();
    }

    private async Task PollServicesAsync()
    {
        while (await pollingTimer!.WaitForNextTickAsync())
        {
            await InvokeAsync(async () =>
            {
                if (!isLoadingServices)
                {
                    await RefreshServices();
                }
            });
        }
    }

    private async Task RefreshServices()
    {
        isLoadingServices = true;
        try
        {
            services = await ServiceManager.GetAllServicesAsync();
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"サービス一覧の読み込みに失敗しました: {ex.Message}", false);
        }
        finally
        {
            isLoadingServices = false;
        }
    }

    private async Task HandleDeleteService(string serviceName)
    {
        try
        {
            var result = await ServiceManager.DeleteServiceAsync(serviceName);
            if (result.Success)
            {
                ShowStatusMessage($"サービスを削除しました", true);
                await RefreshServices();
            }
            else
            {
                ShowStatusMessage($"削除に失敗しました: {result.Message}", false);
            }
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"エラーが発生しました: {ex.Message}", false);
        }
    }

    private async Task StartAllServices()
    {
        if (services == null || services.Count == 0) return;
        isLoadingServices = true;
        try
        {
            var stoppedServices = services.Where(s => s.Status != ServiceStatus.Running).ToList();
            int successCount = 0;
            int failureCount = 0;

            foreach (var service in stoppedServices)
            {
                var result = await ServiceManager.StartServiceAsync(service.ServiceName);
                if (result.Success)
                    successCount++;
                else
                    failureCount++;
            }

            if (stoppedServices.Count == 0)
                ShowStatusMessage("起動するサービスはありません", false);
            else
                ShowStatusMessage($"{successCount}個を起動しました{(failureCount > 0 ? $"、{failureCount}個失敗" : "")}", failureCount == 0);

            await RefreshServices();
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"エラーが発生しました: {ex.Message}", false);
        }
        finally
        {
            isLoadingServices = false;
        }
    }

    private async Task StopAllServices()
    {
        if (services == null || services.Count == 0) return;
        isLoadingServices = true;
        try
        {
            var runningServices = services.Where(s => s.Status == ServiceStatus.Running).ToList();
            int successCount = 0;
            int failureCount = 0;

            foreach (var service in runningServices)
            {
                var result = await ServiceManager.StopServiceAsync(service.ServiceName);
                if (result.Success)
                    successCount++;
                else
                    failureCount++;
            }

            if (runningServices.Count == 0)
                ShowStatusMessage("停止するサービスはありません", false);
            else
                ShowStatusMessage($"{successCount}個を停止しました{(failureCount > 0 ? $"、{failureCount}個失敗" : "")}", failureCount == 0);

            await RefreshServices();
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"エラーが発生しました: {ex.Message}", false);
        }
        finally
        {
            isLoadingServices = false;
        }
    }

    private async Task RestartAllServices()
    {
        if (services == null || services.Count == 0) return;
        isLoadingServices = true;
        try
        {
            var runningServices = services.Where(s => s.Status == ServiceStatus.Running).ToList();
            int successCount = 0;
            int failureCount = 0;

            foreach (var service in runningServices)
            {
                var result = await ServiceManager.RestartServiceAsync(service.ServiceName);
                if (result.Success)
                    successCount++;
                else
                    failureCount++;
            }

            if (runningServices.Count == 0)
                ShowStatusMessage("再起動するサービスはありません", false);
            else
                ShowStatusMessage($"{successCount}個を再起動しました{(failureCount > 0 ? $"、{failureCount}個失敗" : "")}", failureCount == 0);

            await RefreshServices();
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"エラーが発生しました: {ex.Message}", false);
        }
        finally
        {
            isLoadingServices = false;
        }
    }

    private void ShowStatusMessage(string message, bool isSuccess)
    {
        statusMessage = message;
        statusMessageIsSuccess = isSuccess;
        _ = Task.Delay(4000).ContinueWith(_ =>
        {
            statusMessage = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (pollingTimer is not null)
        {
            pollingTimer.Dispose();
        }
    }
}
