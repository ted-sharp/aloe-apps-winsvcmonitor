@page "/services"
@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@using Aloe.Apps.ServiceMonitorServer.Components.Shared
@attribute [Authorize]
@inject IServiceManager ServiceManager
@rendermode InteractiveServer

<PageTitle>サービス監視</PageTitle>

<main class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem">
        <h1>Windows サービス監視</h1>
        <div style="display: flex; gap: 0.5rem">
            <button class="btn-sm" @onclick="RefreshServices" disabled="@isLoadingServices">
                <span class="oi oi-reload" aria-hidden="true"></span> リフレッシュ
            </button>
        </div>
    </div>

    @if (services == null)
    {
        <aside class="alert alert-info" role="alert">
            <span class="spinner" role="status" aria-hidden="true"></span>
            ロード中...
        </aside>
    }
    else if (services.Count == 0)
    {
        <aside class="alert alert-warning" role="alert">
            監視対象のサービスが設定されていません。appsettings.services.json を設定してください。
        </aside>
    }
    else
    {
        <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem">
            @foreach (var service in services)
            {
                <ServiceCard Service="service" OnServiceChanged="RefreshServices" OnDeleteService="HandleDeleteService" />
            }
        </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <aside class="alert @(statusMessageIsSuccess ? "alert-success" : "alert-danger") alert-sm" role="alert" style="position: fixed; bottom: 1rem; right: 1rem; max-width: 400px">
            @statusMessage
        </aside>
    }
</main>

@code {
    private List<ServiceInfo>? services;
    private bool isLoadingServices = false;
    private string statusMessage = string.Empty;
    private bool statusMessageIsSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        await RefreshServices();
    }

    private async Task RefreshServices()
    {
        isLoadingServices = true;
        try
        {
            services = await ServiceManager.GetAllServicesAsync();
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"サービス一覧の読み込みに失敗しました: {ex.Message}", false);
        }
        finally
        {
            isLoadingServices = false;
        }
    }

    private async Task HandleDeleteService(string serviceName)
    {
        try
        {
            var result = await ServiceManager.DeleteServiceAsync(serviceName);
            if (result.Success)
            {
                ShowStatusMessage($"サービスを削除しました", true);
                await RefreshServices();
            }
            else
            {
                ShowStatusMessage($"削除に失敗しました: {result.Message}", false);
            }
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"エラーが発生しました: {ex.Message}", false);
        }
    }

    private void ShowStatusMessage(string message, bool isSuccess)
    {
        statusMessage = message;
        statusMessageIsSuccess = isSuccess;
        _ = Task.Delay(4000).ContinueWith(_ =>
        {
            statusMessage = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }
}
