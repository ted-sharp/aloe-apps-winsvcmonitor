@page "/services"
@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@using Aloe.Apps.ServiceMonitorServer.Components.Shared
@attribute [Authorize]
@inject IServiceManager ServiceManager
@rendermode InteractiveServer

<PageTitle>サービス監視</PageTitle>

<main class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem">
        <h1>Windows サービス監視</h1>
        <button class="btn-sm" @onclick="RefreshServices">
            <span class="oi oi-reload" aria-hidden="true"></span> リフレッシュ
        </button>
    </div>

    @if (services == null)
    {
        <aside class="alert alert-info" role="alert">
            <span class="spinner" role="status" aria-hidden="true"></span>
            ロード中...
        </aside>
    }
    else if (services.Count == 0)
    {
        <aside class="alert alert-warning" role="alert">
            監視対象のサービスが設定されていません。appsettings.jsonを確認してください。
        </aside>
    }
    else
    {
        <div class="grid">
            @foreach (var service in services)
            {
                <ServiceCard Service="service" OnServiceChanged="RefreshServices" />
            }
        </div>
    }
</main>

@code {
    private List<ServiceInfo>? services;

    protected override async Task OnInitializedAsync()
    {
        await RefreshServices();
    }

    private async Task RefreshServices()
    {
        try
        {
            services = await ServiceManager.GetAllServicesAsync();
        }
        catch
        {
            // エラーハンドリング
        }
    }
}
