@page "/services-table"
@using Aloe.Apps.ServiceMonitorLib.Models
@using Aloe.Apps.ServiceMonitorLib.Interfaces
@using Aloe.Apps.ServiceMonitorServer.Components.Shared
@attribute [Authorize]
@inject IServiceManager ServiceManager
@inject IServiceRegistrar ServiceRegistrar
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>サービス監視</PageTitle>

<main class="container">
    <header class="header-with-controls">
        <hgroup>
            <h1>Windows サービス監視</h1>
        </hgroup>
        <form method="post" action="/logout">
            <button type="submit" class="icon-button" title="ログアウト">
                <i data-lucide="x"></i>
            </button>
        </form>
    </header>

    <div role="group">
        <button @onclick="RefreshServices" disabled="@isLoadingServices">
            <i data-lucide="refresh-cw"></i>リフレッシュ
        </button>
        <button class="success" @onclick="StartAllServices" disabled="@isLoadingServices">
            <i data-lucide="play"></i>すべて起動
        </button>
        <button class="danger" @onclick="StopAllServices" disabled="@isLoadingServices">
            <i data-lucide="square"></i>すべて停止
        </button>
        <button class="warning" @onclick="RestartAllServices" disabled="@isLoadingServices">
            <i data-lucide="rotate-cw"></i>すべて再起動
        </button>
    </div>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <article role="alert" class="@(statusMessageIsSuccess ? "" : "")">
            <p>@statusMessage</p>
            <button @onclick="ClearStatusMessage">閉じる</button>
        </article>
    }

    @if (services == null)
    {
        <article aria-busy="true">ロード中...</article>
    }
    else if (services.Count == 0)
    {
        <article>
            <p>監視対象のサービスが設定されていません。appsettings.services.json を設定してください。</p>
        </article>
    }
    else
    {
        <div class="table-overflow">
            <table>
                <thead>
                    <tr>
                        <th>サービス情報</th>
                        <th class="col-status">ステータス</th>
                        <th>操作</th>
                    </tr>
                </thead>
                    @foreach (var service in services)
                    {
                        var isSelected = selectedServiceName == service.ServiceName;

                        <tbody class="service-group @(isSelected ? "selected" : "")" @onclick="() => SelectService(service.ServiceName)">
                        <!-- メイン行 -->
                        <tr class="row-main">
                            <td>
                                <strong>@service.DisplayName</strong>
                            </td>
                            <td rowspan="2" class="col-status">
                                <mark>@GetStatusText(service)</mark>
                            </td>
                            <td rowspan="2">
                                <div role="group">
                                    <button class="success icon-only"
                                            @onclick="() => StartService(service.ServiceName)"
                                            disabled="@(service.Status != ServiceStatus.Stopped)"
                                            title="起動">
                                        <i data-lucide="play"></i>
                                    </button>
                                    <button class="danger icon-only"
                                            @onclick="() => StopService(service.ServiceName)"
                                            disabled="@(service.Status != ServiceStatus.Running)"
                                            title="停止">
                                        <i data-lucide="square"></i>
                                    </button>
                                    <button class="warning icon-only"
                                            @onclick="() => RestartService(service.ServiceName)"
                                            disabled="@(service.Status != ServiceStatus.Running)"
                                            title="再起動">
                                        <i data-lucide="rotate-cw"></i>
                                    </button>
                                    <button class="contrast outline icon-only"
                                            @onclick="() => RegisterService(service)"
                                            disabled="@(service.Status != ServiceStatus.Unknown || string.IsNullOrEmpty(service.BinaryPath))"
                                            title="登録">
                                        <i data-lucide="plus-circle"></i>
                                    </button>
                                    <button class="delete icon-only"
                                            @onclick="() => DeleteService(service.ServiceName)"
                                            disabled="@(service.Status != ServiceStatus.Stopped)"
                                            title="解除">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <!-- 詳細行 -->
                        <tr class="row-detail">
                            <td>
                                <div class="row-details-content">
                                    <span>
                                        <i data-lucide="settings"></i>
                                        @service.StartupType
                                    </span>

                                    @if (service.Status == ServiceStatus.Running && service.Uptime != TimeSpan.Zero)
                                    {
                                        <span>
                                            <i data-lucide="clock"></i>
                                            稼働時間: @FormatUptime(service.Uptime)
                                        </span>
                                    }
                                    @if (service.MemoryUsageMB > 0)
                                    {
                                        <span>
                                            <i data-lucide="cpu"></i>
                                            メモリ: @service.MemoryUsageMB.ToString("F1") MB
                                        </span>
                                    }
                                    @if (service.ProcessId > 0)
                                    {
                                        <span>
                                            <i data-lucide="hash"></i>
                                            PID: @service.ProcessId
                                        </span>
                                    }
                                    @if (service.DependentServicesCount > 0)
                                    {
                                        <span>
                                            <i data-lucide="link"></i>
                                            依存: @service.DependentServicesCount 個
                                        </span>
                                    }
                                    @if (service.LastStatusChange.HasValue)
                                    {
                                        <span>
                                            <i data-lucide="calendar"></i>
                                            最終変更: @FormatRelativeTime(service.LastStatusChange.Value)
                                        </span>
                                    }
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    }
            </table>
        </div>

        <!-- 詳細エリア -->
        @if (!string.IsNullOrEmpty(selectedServiceName) && services.FirstOrDefault(s => s.ServiceName == selectedServiceName) is ServiceInfo selectedService)
        {
            <article class="service-details-panel">
                <header>
                    <div>
                        <h3>詳細情報</h3>
                        <p style="margin: 0; color: var(--pico-muted-color);">@selectedService.DisplayName</p>
                    </div>
                    <button class="icon-button" @onclick="ClearSelection" title="閉じる">
                        <i data-lucide="x"></i>
                    </button>
                </header>

                <div class="details-grid">
                    <div class="detail-item">
                        <label><strong>説明</strong></label>
                        <p>@(string.IsNullOrEmpty(selectedService.Description) ? "（未設定）" : selectedService.Description)</p>
                    </div>

                    <div class="detail-item">
                        <label><strong>バイナリパス</strong></label>
                        <p class="path-text">@(string.IsNullOrEmpty(selectedService.BinaryPath) ? "（未設定）" : selectedService.BinaryPath)</p>
                    </div>
                </div>
            </article>
        }
    }
</main>

@code {
    private List<ServiceInfo>? services;
    private bool isLoadingServices = false;
    private string statusMessage = string.Empty;
    private bool statusMessageIsSuccess = false;
    private PeriodicTimer? pollingTimer;
    private string? selectedServiceName;

    protected override async Task OnInitializedAsync()
    {
        await RefreshServices();
        pollingTimer = new PeriodicTimer(TimeSpan.FromSeconds(3));
        _ = PollAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("lucide.createIcons");
    }

    private async Task PollAsync()
    {
        while (await pollingTimer!.WaitForNextTickAsync())
        {
            await InvokeAsync(async () =>
            {
                if (!isLoadingServices)
                    await RefreshServices();
            });
        }
    }

    private async Task RefreshServices()
    {
        isLoadingServices = true;
        try { services = await ServiceManager.GetAllServicesAsync(); }
        catch { }
        finally { isLoadingServices = false; }
    }

    private async Task StartService(string name)
    {
        var result = await ServiceManager.StartServiceAsync(name);
        if (!result.Success)
            ShowStatusMessage($"起動に失敗しました: {result.Message}", false);
        await RefreshServices();
    }

    private async Task StopService(string name)
    {
        var result = await ServiceManager.StopServiceAsync(name);
        if (!result.Success)
            ShowStatusMessage($"停止に失敗しました: {result.Message}", false);
        await RefreshServices();
    }

    private async Task RestartService(string name)
    {
        var result = await ServiceManager.RestartServiceAsync(name);
        if (!result.Success)
            ShowStatusMessage($"再起動に失敗しました: {result.Message}", false);
        await RefreshServices();
    }

    private async Task DeleteService(string name)
    {
        try
        {
            var result = await ServiceManager.DeleteServiceAsync(name);
            if (result.Success)
            {
                ShowStatusMessage("サービスを解除しました", true);
                await RefreshServices();
            }
            else
            {
                ShowStatusMessage($"解除に失敗しました: {result.Message}", false);
            }
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"解除に失敗しました: {ex.Message}", false);
        }
    }

    private async Task RegisterService(ServiceInfo service)
    {
        try
        {
            var request = new ServiceRegistrationRequest
            {
                ServiceName = service.ServiceName,
                DisplayName = service.DisplayName,
                BinaryPath = service.BinaryPath,
                BinaryPathAlt = service.BinaryPathAlt
            };
            var result = await ServiceRegistrar.RegisterServiceAsync(request);
            if (result.Success)
            {
                ShowStatusMessage("サービスを登録しました", true);
                await RefreshServices();
            }
            else
            {
                ShowStatusMessage($"登録に失敗しました: {result.Message}", false);
            }
        }
        catch (Exception ex)
        {
            ShowStatusMessage($"登録に失敗しました: {ex.Message}", false);
        }
    }

    private void ShowStatusMessage(string message, bool isSuccess)
    {
        statusMessage = message;
        statusMessageIsSuccess = isSuccess;

        // 成功メッセージのみ自動消去、エラーメッセージは手動で閉じる必要
        if (isSuccess)
        {
            _ = Task.Delay(4000).ContinueWith(_ =>
            {
                statusMessage = string.Empty;
                InvokeAsync(StateHasChanged);
            });
        }
    }

    private void ClearStatusMessage()
    {
        statusMessage = string.Empty;
    }

    private void SelectService(string serviceName)
    {
        selectedServiceName = selectedServiceName == serviceName ? null : serviceName;
    }

    private void ClearSelection()
    {
        selectedServiceName = null;
    }

    private async Task StartAllServices()
    {
        if (services == null) return;
        foreach (var s in services.Where(s => s.Status != ServiceStatus.Running))
            await ServiceManager.StartServiceAsync(s.ServiceName);
        await RefreshServices();
    }

    private async Task StopAllServices()
    {
        if (services == null) return;
        foreach (var s in services.Where(s => s.Status == ServiceStatus.Running))
            await ServiceManager.StopServiceAsync(s.ServiceName);
        await RefreshServices();
    }

    private async Task RestartAllServices()
    {
        if (services == null) return;
        foreach (var s in services.Where(s => s.Status == ServiceStatus.Running))
            await ServiceManager.RestartServiceAsync(s.ServiceName);
        await RefreshServices();
    }

    private string GetStatusText(ServiceInfo service)
    {
        if (service.StartupType == "未登録")
            return "未登録";
        return service.Status switch
        {
            ServiceStatus.Running => "実行中",
            ServiceStatus.Stopped => "停止",
            ServiceStatus.Paused => "一時停止",
            ServiceStatus.Starting => "起動中",
            ServiceStatus.Stopping => "停止中",
            ServiceStatus.Continuing => "再開中",
            ServiceStatus.Pausing => "一時停止中",
            _ => "不明"
        };
    }

    private string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}日 {uptime.Hours}時間 {uptime.Minutes}分";
        else if (uptime.TotalHours >= 1)
            return $"{uptime.Hours}時間 {uptime.Minutes}分";
        else
            return $"{uptime.Minutes}分";
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.Now - dateTime;
        if (diff.TotalSeconds < 60) return "数秒前";
        else if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}分前";
        else if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}時間前";
        else return $"{(int)diff.TotalDays}日前";
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        pollingTimer?.Dispose();
    }
}
